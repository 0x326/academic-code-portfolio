<!DOCTYPE html>
<!-- Scott Campbell form example -->
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="generator" content="HTML Tidy for HTML5 for Linux version 5.4.0">
  <title>Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <link rel="stylesheet" type="text/css" href="style.css">
  <script>
    // Check if user entered text in the user box
    function myCheckSubmit(evt) {
      const form = document.getElementById('form')
      const formFields = form.querySelectorAll('input[type=text], textarea')

      for (const elem of formFields) {
        if (elem.value.length < 3) {
          const error = document.getElementById('error')
          error.innerText = 'You must enter at least three characters into all text fields'
          return false
        }
      }

      error.innerText = ''
      return true
    }
  </script>
  <style>
    div#error:empty {
      display: none;
    }
  </style>
</head>

<body>
  <div class="container-fluid">
    <h1>10/17 Lab &ndash; MEYERJM</h1>
    <div id="formDiv" class="container-fluid center-block">
      <div id="error" class="alert alert-danger" role="alert"></div>
      <form id="form">
        <div class="form-group">
          <label for="user">User:</label>
          <input type="text" name="user" value="DEFAULT INFORMATION" class="form-control" id="user" />
        </div>
        <div class="form-group">
          <label for="affiliation">Affiliation</label>
          <select name="affiliation" class="form-control" id="affiliation">
            <option value="student">
              Student
            </option>
            <option value="faculty">
              Faculty
            </option>
            <option value="other">
              Other
            </option>
          </select>
        </div>
        <div class="form-group">
          <label for="comment">Comment</label>
          <textarea name="comment" rows="5" cols="40" class="form-control" id="comment"></textarea>
        </div>
        <div class="form-group">
          <label for="question6-car">Car</label>
          <input id="question6-car" type="text" class="form-control" name="car" />
        </div>
        <div id="question6-div" class="form-group">
          <label for="question6-colors"></label>
          <select id="question6-colors" class="form-control" name="color">
            <option value="">
              My favorite colors are:
            </option>
            <option value="bright">
              Bright
            </option>
            <option value="blue">
              Blues
            </option>
            <option value="red">
              Reds
            </option>
            <option value="darks">
              Dark colors
            </option>
            <option value="eclectic">
              Eclectic
            </option>
            <option value="other">
              Other
            </option>
          </select>
        </div>
        <div class="form-group">
          <input type="submit" name="submit" value="Submit" class="form-control" />
        </div>
      </form>
    </div>

    <div id="submissions-table-div">
      <table id="submissions-table" class="table table-condensed table-striped"></table>
    </div>

    <div>
      <button id="start-new-form-button" type="button" class="btn btn-default">
        Start new form
      </button>
    </div>
  </div>
  <script>
    async function sendAjaxRequest(ajaxOptions) {
      // Convert jQuery thenables into native Promises
      const data = await Promise.resolve($.ajax(ajaxOptions))
      if (data.status !== 'OK') {
        throw new Error('Server status !== OK')
      }
      return data
    }

    async function submitFormData(data, retryLimit = 3) {
      if (retryLimit < 0) {
        throw new Error('retryLimit must be non-negative')
      }

      const ajaxOptions = {
        method: 'POST',
        url: 'https://ceclnx01.cec.miamioh.edu/~campbest/cse383/forms1/form-ajax.php',
        data: JSON.stringify(data),
        contentType: 'application/json',
        dataType: 'json',
      }

      let ajaxSubmission = sendAjaxRequest(ajaxOptions)

      for (let i = 0; i < retryLimit; i += 1) {
        ajaxSubmission = ajaxSubmission.catch(() => sendAjaxRequest(ajaxOptions))
      }
      return ajaxSubmission
        .catch(() => $('#error').text('Form cannot be submitted since server is unavailable'))
        .then(({ data }) => {
          $('#formDiv').hide()
          $('#submissions-table-div').show()
          populateTableData('#submissions-table', data)
        })
    }

    function populateTableData(tableSelector, entries) {
      // Assume there is at least one entry
      const tableHeaderKeys = Object.keys(entries[0])

      // Add table headers
      $(tableSelector).html(`
        <thead>
          <tr>
            ${tableHeaderKeys
              .map(property => `<th scope="col">${property}</th>`)
              .join('\n')}
          </tr>
        </thead>
        <tbody></tbody>
      `)

      // Add table rows
      const tbody = $('tbody', tableSelector)
      for (const entry of entries) {
        const rowValues = tableHeaderKeys
          .map(key => entry[key])
          .map(val => `<td>${val}</td>`)
          .join('\n')
        tbody.append(`<tr>${rowValues}</tr>`)
      }
    }

    $(document).ready(() => {
      $('#start-new-form-button').click(() => {
        $('#formDiv').show()
        $('#submissions-table-div').hide()
        $('input[type=text], textarea', '#form').val('')
      })
      $('#form').submit((evt) => {
        evt.preventDefault()
        const inputIsValid = myCheckSubmit()
        if (inputIsValid === true) {
          const dataToSend = {}
          for (const { name, value } of $('#form').serializeArray()) {
            dataToSend[name] = value
          }
          submitFormData(dataToSend)
        }
      })
    })
  </script>
</body>

</html>
